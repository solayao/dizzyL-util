"use strict";var _createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var t=n[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,o,t){return o&&e(n.prototype,o),t&&e(n,t),n}}();function _asyncToGenerator(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,o){return function t(r,s){try{var i=n[r](s),c=i.value}catch(e){return void o(e)}if(!i.done)return Promise.resolve(c).then(function(e){t("next",e)},function(e){t("throw",e)});e(c)}("next")})}}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var MongoDB=require("mongodb"),MongoClient=MongoDB.MongoClient,DBpool=require("./DBpool"),_require=require("./config.json"),mongoConfig=_require.mongoConfig,_require2=require("../log/ChalkConsole"),SuccessConsole=_require2.SuccessConsole,ErrorConsole=_require2.ErrorConsole,InsertConsole=_require2.InsertConsole,dbName=mongoConfig.db,MongoResource=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:mongoConfig,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,e);var t=n.uri||n.url;t||(t=n.user&&n.pass?"mongodb://"+n.user+":"+n.pass+"@"+n.host+":"+n.port+"/"+n.db:"mongodb://"+n.host+":"+n.port+"/"+n.db);var r=function(){return MongoClient.connect(t,{useNewUrlParser:!0}).then(function(e){return SuccessConsole("DBpool message",__filename,"Connected MongoDB ("+t+") successfully to server."),e}).catch(function(e){ErrorConsole("DBpool message",__filename,"Connected MongoDB ("+t+") NOT successfully to server!\n\t"+e)})},s=function(e){e.close(),SuccessConsole("DBpool message",__filename,"Closed MongoDB ("+t+") successfully to server.")};this.mongoPool=Object.keys(o).length>0?new DBpool(r,s,o):new DBpool(r,s)}return _createClass(e,[{key:"close",value:function(){this.mongoPool.closePool()}},{key:"actionInsert",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(n&&""!==e)return Array.isArray(n)&&0===n.length?[]:this.mongoPool.sqlAction(function(o){return new Promise(function(t,r){o.db(dbName).collection(e).insert(n).then(function(o){o.result.hasOwnProperty("ok")&&(SuccessConsole("DBpool message",__filename,"Insert (\n"+JSON.stringify(n)+"\n) to ("+e+") successfully."),InsertConsole("DBpool message",__filename,"Insert (\n"+JSON.stringify(n)+"\n) to ("+e+") successfully."),t(Object.values(o.insertedIds)))}).catch(function(e){return r(e)})})})}},{key:"actionQuery",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(o&&""!==n)return this.mongoPool.sqlAction(function(t){return new Promise((r=_asyncToGenerator(regeneratorRuntime.mark(function r(s,i){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{t.db(dbName).collection(n).find(o).toArray(function(e,n){s(n)})}catch(e){console.log(e)}case 1:case"end":return e.stop()}},r,e)})),function(e,n){return r.apply(this,arguments)}));var r})}},{key:"actionUpdate",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,t=this,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(o&&n&&o)return this.mongoPool.sqlAction(function(i){return new Promise((c=_asyncToGenerator(regeneratorRuntime.mark(function c(u,l){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:i.db(dbName).collection(e).update(n,o,{upsert:r,multi:s}).then(function(n){SuccessConsole("DBpool message",__filename,"Update (\n"+JSON.stringify(o)+"\n) to ("+e+") successfully."),InsertConsole("DBpool message",__filename,"Update (\n"+JSON.stringify(o)+"\n) to ("+e+") successfully."),u()}).catch(function(e){return l(e)});case 1:case"end":return t.stop()}},c,t)})),function(e,n){return c.apply(this,arguments)}));var c})}},{key:"distinct",value:function(){return this.mongoPool.sqlAction(function(e){return new Promise(function(n,o){e.db(dbName).collection("comic").distinct("n").then(function(e){n(e)}).catch(function(e){return o(e)})})})}}]),e}();module.exports=MongoResource;