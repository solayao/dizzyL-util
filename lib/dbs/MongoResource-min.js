"use strict";var _createClass=function(){function o(o,n){for(var e=0;e<n.length;e++){var t=n[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(o,t.key,t)}}return function(n,e,t){return e&&o(n.prototype,e),t&&o(n,t),n}}();function _classCallCheck(o,n){if(!(o instanceof n))throw new TypeError("Cannot call a class as a function")}var MongoDB=require("mongodb"),MongoClient=MongoDB.MongoClient,DBpool=require("./DBpool"),_require=require("./config.json"),mongoConfig=_require.mongoConfig,_require2=require("../log/ChalkConsole"),SuccessConsole=_require2.SuccessConsole,ErrorConsole=_require2.ErrorConsole,InsertConsole=_require2.InsertConsole,dbName=mongoConfig.db,MongoResource=function(){function o(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:mongoConfig,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,o);var t=n.uri||n.url;t||(t=n.user&&n.pass?"mongodb://"+n.user+":"+n.pass+"@"+n.host+":"+n.port+"/"+n.db:"mongodb://"+n.host+":"+n.port+"/"+n.db);var r=function(){return MongoClient.connect(t,{useNewUrlParser:!0}).then(function(o){return SuccessConsole("DBpool message",__filename,"Connected MongoDB ("+t+") successfully to server."),o}).catch(function(o){ErrorConsole("DBpool message",__filename,"Connected MongoDB ("+t+") NOT successfully to server!\n\t"+o)})},l=function(o){o.close(),SuccessConsole("DBpool message",__filename,"Closed MongoDB ("+t+") successfully to server.")};this.mongoPool=Object.keys(e).length>0?new DBpool(r,l,e):new DBpool(r,l)}return _createClass(o,[{key:"close",value:function(){this.mongoPool.closePool()}},{key:"actionInsert",value:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(n&&""!==o)return Array.isArray(n)&&0===n.length?[]:this.mongoPool.sqlAction(function(e){return new Promise(function(t,r){e.db(dbName).collection(o).insert(n).then(function(e){e.result.hasOwnProperty("ok")&&(SuccessConsole("DBpool message",__filename,"Insert (\n"+JSON.stringify(n)+"\n) to ("+o+") successfully."),InsertConsole("DBpool message",__filename,"Insert (\n"+JSON.stringify(n)+"\n) to ("+o+") successfully."),t(Object.values(e.insertedIds)))}).catch(function(o){return r(o)})})})}},{key:"actionQuery",value:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(n&&""!==o)return this.mongoPool.sqlAction(function(e){return new Promise(function(t,r){try{e.db(dbName).collection(o).find(n).toArray(function(o,n){t(n)})}catch(o){console.log(o)}})})}},{key:"actionAggregate",value:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(n&&""!==o)return this.mongoPool.sqlAction(function(e){return new Promise(function(t,r){try{e.db(dbName).collection(o).aggregate(n).toArray(function(o,n){t(n)})}catch(o){console.log(o)}})})}},{key:"actionUpdate",value:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,t=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(e&&n&&e)return this.mongoPool.sqlAction(function(l){return new Promise(function(s,i){l.db(dbName).collection(o).update(n,e,{upsert:t,multi:r}).then(function(n){SuccessConsole("DBpool message",__filename,"Update (\n"+JSON.stringify(e)+"\n) to ("+o+") successfully."),InsertConsole("DBpool message",__filename,"Update (\n"+JSON.stringify(e)+"\n) to ("+o+") successfully."),s()}).catch(function(o){return i(o)})})})}},{key:"actionForClient",value:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(o){};return this.mongoPool.sqlAction(function(n){return o(n)})}},{key:"distinct",value:function(){return this.mongoPool.sqlAction(function(o){return new Promise(function(n,e){o.db(dbName).collection("comic").distinct("n").then(function(o){n(o)}).catch(function(o){return e(o)})})})}}]),o}();module.exports=MongoResource;