"use strict";var _createClass=function(){function e(e,n){for(var r=0;r<n.length;r++){var o=n[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,r,o){return r&&e(n.prototype,r),o&&e(n,o),n}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,r=Array(e.length);n<e.length;n++)r[n]=e[n];return r}return Array.from(e)}function _asyncToGenerator(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,r){return function o(t,i){try{var s=n[t](i),u=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(u).then(function(e){o("next",e)},function(e){o("throw",e)});e(u)}("next")})}}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var Redis=require("redis"),bluebird=require("bluebird");bluebird.promisifyAll(Redis);var DBpool=require("./DBpool"),_require=require("./config.json"),redisConfig=_require.redisConfig,_require2=require("../log/ChalkConsole"),SuccessConsole=_require2.SuccessConsole,ErrorConsole=_require2.ErrorConsole,RedisResource=function(){function e(){var n=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:redisConfig,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,e);var t,i={retry_strategy:function(e){return e.error&&"ETIMEDOUT"===e.error.code&&ErrorConsole("DBpool message",__filename,"Connected MongoDB ("+e.error.address+":"+e.error.port+") NOT successfully to server!"),e.error&&"ECONNREFUSED"===e.error.code?(ErrorConsole("DBpool Message",__filename,""+e.error),new Error("The server refused the connection")):e.total_retry_time>36e5?(ErrorConsole("DBpool Message",__filename,"Retry time exhausted"),new Error("Retry time exhausted")):e.attempt>10?void ErrorConsole("DBpool Message",__filename,"End reconnecting!"):Math.min(100*e.attempt,3e3)}},s=function(){var e=Redis.createClient(Object.assign({},r,i));return e.on("connect",function(){SuccessConsole("DBpool Message",__filename,"Connected Reids ("+r.host+":"+r.port+") successfully to server.")}),e},u=(t=_asyncToGenerator(regeneratorRuntime.mark(function e(o){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.quit();case 2:SuccessConsole("DBpool Message",__filename,"Closed Reids ("+r.host+":"+r.port+") successfully to server.");case 3:case"end":return e.stop()}},e,n)})),function(e){return t.apply(this,arguments)});this.redisPool=Object.keys(o).length>0?new DBpool(s,u,o):new DBpool(s,u)}return _createClass(e,[{key:"close",value:function(){this.redisPool.closePool()}},{key:"action",value:function(e){return this.redisPool.sqlAction(e,__filename)}},{key:"lPush",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;return this.action(function(o){return o.LPUSHAsync.apply(o,[e].concat(_toConsumableArray(n))).then(function(n){return-1!==r&&o.EXPIREAsync(e,r),n})})}},{key:"lRange",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,-1];return this.action(function(r){var o;return(o=console).log.apply(o,[e].concat(_toConsumableArray(n))),r.LRANGEAsync.apply(r,[e].concat(_toConsumableArray(n)))})}},{key:"hmSet",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;return this.action(function(o){return new Promise(function(t,i){e&&o.HMSETAsync(e,n).then(function(){-1!==r&&o.EXPIREAsync(e,r),t()}).catch(function(e){return i(e)})})})}},{key:"hgetAll",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.action(function(n){return new Promise(function(r,o){e&&n.HGETALLAsync(e).then(function(e){return r(e)}).catch(function(e){return o("err",e)})})})}},{key:"keys",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"*";return this.action(function(n){return new Promise(function(r,o){n.KEYSAsync(e).then(function(e){return r(e)}).catch(function(e){return o("err",e)})})})}},{key:"flushall",value:function(){return this.action(function(e){return e.FLUSHALLAsync()})}},{key:"actionForClient",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(e){};return this.action(function(n){return e(n)})}}]),e}();module.exports=RedisResource;