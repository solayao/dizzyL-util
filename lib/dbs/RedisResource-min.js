"use strict";var _createClass=function(){function e(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,r,t){return r&&e(n.prototype,r),t&&e(n,t),n}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,r=Array(e.length);n<e.length;n++)r[n]=e[n];return r}return Array.from(e)}function _asyncToGenerator(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,r){return function t(o,i){try{var u=n[o](i),s=u.value}catch(e){return void r(e)}if(!u.done)return Promise.resolve(s).then(function(e){t("next",e)},function(e){t("throw",e)});e(s)}("next")})}}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var Redis=require("redis"),bluebird=require("bluebird");bluebird.promisifyAll(Redis);var DBpool=require("./DBpool"),_require=require("./config.json"),redisConfig=_require.redisConfig,_require2=require("../log/ChalkConsole"),SuccessConsole=_require2.SuccessConsole,ErrorConsole=_require2.ErrorConsole,RedisResource=function(){function e(){var n=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:redisConfig,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,e);var o,i={retry_strategy:function(e){return e.error&&"ECONNREFUSED"===e.error.code?(ErrorConsole("DBpool Message",__filename,""+e.error),new Error("The server refused the connection")):e.total_retry_time>36e5?(ErrorConsole("DBpool Message",__filename,"Retry time exhausted"),new Error("Retry time exhausted")):e.attempt>10?void 0:Math.min(100*e.attempt,3e3)}},u=function(){var e=Redis.createClient(Object.assign({},r,i));return SuccessConsole("DBpool Message",__filename,"Connected Reids ("+redisConfig.host+":"+redisConfig.port+") successfully to server."),e},s=(o=_asyncToGenerator(regeneratorRuntime.mark(function e(r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.quit();case 2:SuccessConsole("DBpool Message",__filename,"Closed Reids ("+redisConfig.host+":"+redisConfig.port+") successfully to server.");case 3:case"end":return e.stop()}},e,n)})),function(e){return o.apply(this,arguments)});this.redisPool=Object.keys(t).length>0?new DBpool(u,s,t):new DBpool(u,s)}return _createClass(e,[{key:"close",value:function(){this.redisPool.closePool()}},{key:"action",value:function(e){return this.redisPool.sqlAction(e,__filename)}},{key:"lPush",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;this.action(function(t){return t.LPUSHAsync.apply(t,[e].concat(_toConsumableArray(n))).then(function(n){return-1!==r&&t.EXPIREAsync(e,r),n})})}},{key:"lRange",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,-1];this.action(function(r){return r.LRANGEAsync.apply(r,[e].concat(_toConsumableArray(n)))})}},{key:"hmSet",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;this.action(function(t){return new Promise(function(o,i){e&&t.HMSETAsync(e,n).then(function(){-1!==r&&t.EXPIREAsync(e,r),o()}).catch(function(e){return i(e)})})})}},{key:"hgetAll",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.action(function(n){return new Promise(function(r,t){e&&n.HGETALLAsync(e).then(function(e){return r(e)}).catch(function(e){return t("err",e)})})})}},{key:"keys",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"*";return this.action(function(n){return new Promise(function(r,t){n.KEYSAsync(e).then(function(e){return r(e)}).catch(function(e){return t("err",e)})})})}},{key:"flushall",value:function(){return this.action(function(e){return e.FLUSHALLAsync()})}},{key:"actionForClient",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(e){};return this.action(function(n){return e(n)})}}]),e}();module.exports=RedisResource;