"use strict";var _extends=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}();function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,n){return function t(o,a){try{var c=r[o](a),i=c.value}catch(e){return void n(e)}if(!c.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});e(i)}("next")})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var Crawler=require("crawler"),seenreq=require("seenreq"),_require=require("../log/ChalkConsole"),SuccessConsole=_require.SuccessConsole,ErrorConsole=_require.ErrorConsole,WarningConsole=_require.WarningConsole,_require2=require("./PublicReg"),imgReg=_require2.imgReg,DizzyCrawler=function(){function e(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e);var n={maxConnections:20,callback:function(e,r,n){e?ErrorConsole("Crawler catch",__filename,e):SuccessConsole("Crawler catch",__filename,"["+r.request.method+" "+r.statusCode+"] \n\t"+r.request.uri.href),n()}};this.crawler=new Crawler(Object.assign({},n,r)),this.seen=new seenreq,process.on("unhandledRejection",function(e,r){WarningConsole("UnhandledRejection",__filename),console.log(r)})}return _createClass(e,[{key:"getSeen",value:function(){return this.seen}},{key:"queue",value:function(e){this.crawler.queue(e)}},{key:"promiseQueue",value:function(e,r){var n=this;if(Array.isArray(e))return new Promise((t=_asyncToGenerator(regeneratorRuntime.mark(function t(o,a){var c,i,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return c=[],i=e,s=function(e){return Promise.all(e.map(function(e){return n.promiseQueue(e,r)})).then(function(e){if((c=e.filter(function(e){return e})).length>0){var r=""+c.map(function(e,r){return(r?"\n\t":"")+'"'+e.uri+'"'});ErrorConsole("Group Error Crawler",__filename,r)}}).catch(function(e){a(e)})},t.next=4,s(i);case 4:o();case 5:case"end":return t.stop()}},t,n)})),function(e,r){return t.apply(this,arguments)}));var t,o="string"==typeof e?e:e.uri,a=imgReg.test(o);return new Promise(function(t,c){try{var i=(u=_asyncToGenerator(regeneratorRuntime.mark(function i(s,u,l){var f,h,p;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!s){i.next=2;break}throw s;case 2:if(f="Crawler Catch "+(a?"IMAGE":"HTML"),h="["+u.request.method+" "+u.statusCode+"] \n\t"+o,200!==u.statusCode){i.next=12;break}return i.next=7,n.seen.exists(e,function(e,r){if(e)throw e});case 7:SuccessConsole(f,__filename,h),r&&r(u),t(),i.next=27;break;case 12:if(![403,404].includes(u.statusCode)){i.next=26;break}p="",i.t0=u.statusCode,i.next=403===i.t0?17:404===i.t0?19:21;break;case 17:return p="\n\tSorry, You don't have permission to access the URL("+o+") on this server!",i.abrupt("break",22);case 19:return p="\n\tSorry, the URL("+o+") is missing in the web! "+(new Date).valueOf(),i.abrupt("break",22);case 21:p="\n\tCrawler catch error.";case 22:ErrorConsole(f,__filename,""+h+p),c({options:e}),i.next=27;break;case 26:WarningConsole(f,__filename,"未收录状态: "+u.statusCode);case 27:l();case 28:case"end":return i.stop()}},i,n)})),function(e,r,n){return u.apply(this,arguments)}),s=Object.assign("object"===(void 0===e?"undefined":_typeof(e))?_extends({},e,{callback:i}):{uri:e,callback:i},a?{encoding:null,jQuery:!1}:{});n.crawler.queue(s)}catch(e){ErrorConsole("During Crawler",__filename,"Crawler在执行callback时发生了错误！"),c(e)}var u}).catch(function(e){return e.options})}},{key:"createCrawler",value:function(){var e=this,r=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).map(function(r){var n=r.crawlerType,t=r.crawlerOptions,o=r.catchObj;if("promise"===n)return e.promiseQueue(t,function(r){var n=r.$,t=o.catchKey,a=o.catchFunc,c=o.catchReg,i=o.catchSuccActions;"each"===a&&n(t).each(function(r,o){var a=n(o).html(),s=e.regs.hasOwnProperty(c)?e.regs[c]:c;if(s.test(a)){var u={};i.forEach(function(r){var n=r.actionType,t=r.actionName,o=r.actionFunc,a=r.actionProps,c=r.actionTo;"eq"===n?u[c]="":"if"===n||e.nextProps[t][o](a.includes("$")?RegExp[a]:a)})}else console.log(t+"的第"+r+"个+配置[ "+s+" ]失败")})})});return Promise.all(r)}}]),e}();module.exports=DizzyCrawler;